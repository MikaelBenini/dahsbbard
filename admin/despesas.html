<!DOCTYPE html>
<html lang="pt-BR" class="has-aside-left has-aside-mobile-transition has-navbar-fixed-top has-aside-expanded">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Despesas</title>
  <link rel="stylesheet" href="css/main.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
  <link rel="dns-prefetch" href="https://fonts.gstatic.com">
  <link href="https://fonts.googleapis.com/css?family=Nunito" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="https://cdn.materialdesignicons.com/4.9.95/css/materialdesignicons.min.css">
  <!-- Toastify CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
</head>
<body>
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const usuario = localStorage.getItem('usuario');
      const permissao = localStorage.getItem('permissao');
  
      // Verifica se o usuário e permissão estão armazenados no localStorage
      if (!usuario || !permissao) {
        alert('Você não está autenticado! Redirecionando para o login...');
        window.location.href = '../login.html'; // Redireciona para a página de login
      }
  
      // Verificação adicional para garantir que o usuário tem a permissão certa para acessar a página
      if (permissao !== 'admin') {
        alert('Você não tem permissão para acessar essa área!');
        window.location.href = '../login.html'; // Redireciona para o login se não tiver permissão
      }
    });
  </script>
<div id="app">
  <nav id="navbar-main" class="navbar is-fixed-top">
    <div class="navbar-brand">
      <a class="navbar-item is-hidden-desktop jb-aside-mobile-toggle">
        <span class="icon"><i class="mdi mdi-forwardburger mdi-24px"></i></span>
      </a>
    </div>
    <div class="navbar-brand is-right">
      <a class="navbar-item is-hidden-desktop jb-navbar-menu-toggle" data-target="navbar-menu">
        <span class="icon"><i class="mdi mdi-dots-vertical"></i></span>
      </a>
    </div>
    <div class="navbar-menu fadeIn animated faster" id="navbar-menu">
      <div class="navbar-end">
        <a title="Log out" class="navbar-item is-desktop-icon-only">
          <span class="icon"><i class="mdi mdi-logout"></i></span><span>Log out</span>
        </a>
      </div>
    </div>
  </nav>
  <aside class="aside is-placed-left is-expanded">
    <div class="aside-tools">
      <div class="aside-tools-label">
        <span><b>Admin</b></span>
      </div>
    </div>
    <div class="menu is-menu-main">
      <p class="menu-label">Geral</p>
      <ul class="menu-list">
        <li><a href="index.html" class="has-icon"><span class="icon"><i class="mdi mdi-desktop-mac"></i></span><span class="menu-item-label">Dashboard</span></a></li>
        <li><a href="usuarios.html" class="has-icon"><span class="icon"><i class="mdi mdi-account-circle"></i></span><span class="menu-item-label">Usuários</span></a></li>
        <li><a href="estoque.html" class="has-icon"><span class="icon"><i class="mdi mdi-warehouse"></i></span><span class="menu-item-label">Estoque</span></a></li>
        <li><a href="lancamentos.html" class=" has-icon"><span class="icon"><i class="mdi mdi-currency-brl"></i></span><span class="menu-item-label">Lancamentos</span></a></li>
        <li><a href="despesas.html" class="is-active has-icon"><span class="icon"><i class="mdi mdi-currency-brl"></i></span><span class="menu-item-label">Despesas</span></a></li>
      </ul>
      <p class="menu-label">Logic Ice</p>
      <ul class="menu-list">
        <li><a href="../producao/producao.html" class="has-icon"><span class="icon has-update-mark"><i class="mdi mdi-table"></i></span><span class="menu-item-label">Produção</span></a></li>
        <li><a href="vendas.html" class="has-icon"><span class="icon"><i class="mdi mdi-square-edit-outline"></i></span><span class="menu-item-label">Vendas</span></a></li>
        <li><a href="entregas.html" class="has-icon"><span class="icon"><i class="mdi mdi-square-edit-outline"></i></span><span class="menu-item-label">Entregas</span></a></li>
      </ul>
    </div>
  </aside>
  <section class="section is-title-bar">
    <div class="level">
      <div class="level-left">
        <div class="level-item">
          <ul><li>Admin</li><li>Despesas</li></ul>
        </div>
      </div>
    </div>
  </section>
  <section class="hero is-hero-bar">
    <div class="hero-body">
      <div class="level">
        <div class="level-left">
          <div class="level-item"><h1 class="title">Despesas</h1></div>
        </div>
        <div class="level-right">
          <div class="level-item">
            <button id="addDespesaBtn" class="button is-success mr-2">Adicionar Despesa</button>
            <button id="exportCsvBtn" class="button is-info mr-2">Exportar CSV</button>
            <button id="refreshDespesasBtn" class="button is-primary">Atualizar</button>
          </div>
        </div>
      </div>
    </div>
  </section>
  <section class="section is-main-section">
    <div class="card mb-6">
      <header class="card-header">
        <p class="card-header-title"><span class="icon"><i class="mdi mdi-currency-brl"></i></span>Registro de Despesas</p>
      </header>
      <div class="card-content">
        <form id="filterDespesasForm">
          <div class="field is-horizontal is-spaced">
            <div class="field-label is-normal"><label class="label">Filtros</label></div>
            <div class="field-body">
              <div class="field mr-4">
                <p class="control is-expanded has-icons-left">
                  <input class="input" type="text" id="descricao" placeholder="Descrição da Despesa">
                  <span class="icon is-small is-left"><i class="mdi mdi-text"></i></span>
                </p>
              </div>
              <div class="field mr-4 is-narrow">
                <div class="control">
                  <div class="select is-fullwidth">
                    <select id="categoria">
                      <option value="">Todas as Categorias</option>
                    </select>
                  </div>
                </div>
              </div>
              <div class="field mr-4 is-narrow">
                <div class="control">
                  <div class="select is-fullwidth">
                    <select id="tipo">
                      <option value="">Todos os Tipos</option>
                      <option value="fixa">Fixa</option>
                      <option value="variavel">Variável</option>
                    </select>
                  </div>
                </div>
              </div>
              <div class="field">
                <div class="control">
                  <button type="submit" class="button is-primary">Filtrar</button>
                </div>
              </div>
            </div>
          </div>
        </form>
        <form id="addCategoriaForm" class="mb-4">
          <div class="field is-horizontal is-spaced">
            <div class="field-label is-normal"><label class="label">Adicionar Categoria</label></div>
            <div class="field-body">
              <div class="field mr-4">
                <p class="control is-expanded">
                  <input class="input" type="text" id="novaCategoria" placeholder="Nome da nova categoria" required maxlength="50">
                </p>
              </div>
              <div class="field">
                <div class="control">
                  <button type="submit" class="button is-success">Adicionar</button>
                </div>
              </div>
            </div>
          </div>
        </form>
        <div class="table-container">
          <table class="table is-fullwidth is-striped is-hoverable">
            <thead>
              <tr>
                <th>ID</th>
                <th>Descrição</th>
                <th>Valor</th>
                <th>Categoria</th>
                <th>Data da Despesa</th>
                <th>Tipo</th>
                <th>Data de Criação</th>
                <th>Ações</th>
              </tr>
            </thead>
            <tbody id="despesasTable"></tbody>
          </table>
        </div>
      </div>
    </div>
    <!-- Modal Adicionar Despesa -->
    <div class="modal" id="addDespesaModal">
      <div class="modal-background"></div>
      <div class="modal-card">
        <header class="modal-card-head">
          <p class="modal-card-title">Adicionar Despesa</p>
          <button class="delete" aria-label="close" onclick="closeAddModal()"></button>
        </header>
        <section class="modal-card-body">
          <form id="addDespesaForm">
            <div class="field">
              <label class="label">Descrição</label>
              <div class="control">
                <input class="input" type="text" id="addDescricao" required minlength="3" maxlength="255">
              </div>
            </div>
            <div class="field">
              <label class="label">Valor (R$)</label>
              <div class="control">
                <input class="input" type="number" id="addValor" step="0.01" min="0.01" required>
              </div>
            </div>
            <div class="field">
              <label class="label">Categoria</label>
              <div class="control">
                <div class="select is-fullwidth">
                  <select id="addCategoria" required>
                    <option value="">Selecione uma categoria</option>
                  </select>
                </div>
              </div>
            </div>
            <div class="field">
              <label class="label">Data da Despesa</label>
              <div class="control">
                <input class="input" type="date" id="addDataDespesa" required max="2025-05-01">
              </div>
            </div>
            <div class="field">
              <label class="label">Tipo</label>
              <div class="control">
                <div class="select is-fullwidth">
                  <select id="addTipo" required>
                    <option value="variavel">Variável</option>
                    <option value="fixa">Fixa</option>
                  </select>
                </div>
              </div>
            </div>
          </form>
        </section>
        <footer class="modal-card-foot">
          <button class="button is-success" onclick="salvarNovaDespesa()">Salvar</button>
          <button class="button" onclick="closeAddModal()">Cancelar</button>
        </footer>
      </div>
    </div>
    <!-- Modal Editar Despesa -->
    <div class="modal" id="editDespesaModal">
      <div class="modal-background"></div>
      <div class="modal-card">
        <header class="modal-card-head">
          <p class="modal-card-title">Editar Despesa</p>
          <button class="delete" aria-label="close" onclick="closeEditModal()"></button>
        </header>
        <section class="modal-card-body">
          <form id="editDespesaForm">
            <div class="field">
              <label class="label">ID</label>
              <div class="control">
                <input class="input" type="text" id="editId" readonly>
              </div>
            </div>
            <div class="field">
              <label class="label">Descrição</label>
              <div class="control">
                <input class="input" type="text" id="editDescricao" required minlength="3" maxlength="255">
              </div>
            </div>
            <div class="field">
              <label class="label">Valor (R$)</label>
              <div class="control">
                <input class="input" type="number" id="editValor" step="0.01" min="0.01" required>
              </div>
            </div>
            <div class="field">
              <label class="label">Categoria</label>
              <div class="control">
                <div class="select is-fullwidth">
                  <select id="editCategoria" required>
                    <option value="">Selecione uma categoria</option>
                  </select>
                </div>
              </div>
            </div>
            <div class="field">
              <label class="label">Data da Despesa</label>
              <div class="control">
                <input class="input" type="date" id="editDataDespesa" required max="2025-05-01">
              </div>
            </div>
            <div class="field">
              <label class="label">Tipo</label>
              <div class="control">
                <div class="select is-fullwidth">
                  <select id="editTipo" required>
                    <option value="variavel">Variável</option>
                    <option value="fixa">Fixa</option>
                  </select>
                </div>
              </div>
            </div>
          </form>
        </section>
        <footer class="modal-card-foot">
          <button class="button is-success" onclick="salvarEdicao()">Salvar</button>
          <button class="button is-danger" onclick="confirmarDelecao()">Deletar</button>
          <button class="button" onclick="closeEditModal()">Cancelar</button>
        </footer>
      </div>
    </div>
  </section>
  <style>
    .table-container {
      max-height: 400px;
      overflow-y: auto;
      margin-top: 1rem;
    }
    .table th, .table td {
      padding: 0.75rem;
      text-align: left;
      border-bottom: 1px solid #e5e7eb;
    }
    .table th {
      background-color: #f3f4f6;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    .field.is-horizontal.is-spaced .field-body .field {
      margin-bottom: 0.75rem;
    }
    .modal-card-body {
      max-height: 70vh;
      overflow-y: auto;
    }
    .has-background-danger-light {
      background-color: #fff5f5;
    }
  </style>
  <footer class="footer">
    <div class="container-fluid">
      <div class="level">
        <div class="level-left">
          <div class="level-item">© 2025, M</div>
          <div class="level-item">
            <img src="https://img.shields.io/github/v/release/vikdiesel/admin-one-bulma-dashboard?color=%23999">
          </div>
        </div>
        <div class="level-right"><div class="level-item"></div></div>
      </div>
    </div>
  </footer>
</div>
<!-- Toastify JS -->
<script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
<script>
// Função para exibir notificações com Toastify
function showToast(message, type = 'success') {
  Toastify({
    text: message,
    duration: 3000,
    close: true,
    gravity: 'top',
    position: 'right',
    backgroundColor: type === 'success' ? '#2ecc71' : '#e74c3c',
    stopOnFocus: true
  }).showToast();
}

// Logout
document.querySelector('.navbar-item[title="Log out"]').addEventListener('click', () => {
  localStorage.removeItem('usuario');
  localStorage.removeItem('permissao');
  window.location.href = '../login.html';
});

// Função para formatar datas
function formatarData(data) {
  try {
    const d = new Date(data);
    if (isNaN(d.getTime())) throw new Error('Data inválida');
    return d.toLocaleDateString('pt-BR');
  } catch (error) {
    console.error('Erro ao formatar data:', error);
    return 'Data inválida';
  }
}

// Função para formatar nome da categoria
function formatarCategoria(categoria) {
  if (!categoria) return 'Sem categoria';
  return categoria.charAt(0).toUpperCase() + categoria.slice(1);
}

// Função para buscar e atualizar as despesas
async function atualizarDespesas(filtros = {}) {
  const tbody = document.getElementById('despesasTable');
  if (!tbody) {
    console.error('Elemento com ID "despesasTable" não encontrado no DOM');
    showToast('Erro: Tabela de despesas não encontrada', 'error');
    return;
  }
  tbody.innerHTML = '<tr><td colspan="8" class="has-text-centered">Carregando...</td></tr>';
  try {
    const query = new URLSearchParams(filtros).toString();
    const response = await fetch(`/api/despesas?${query}`, {
      headers: { 'Accept': 'application/json' }
    });
    if (!response.ok) {
      const text = await response.text();
      throw new Error(`Erro na resposta do servidor: ${response.status} ${response.statusText}`);
    }
    const despesas = await response.json();
    tbody.innerHTML = '';
    if (!Array.isArray(despesas)) {
      throw new Error('Resposta da API não é um array: ' + JSON.stringify(despesas));
    }
    if (despesas.length === 0) {
      tbody.innerHTML = '<tr><td colspan="8" class="has-text-centered">Nenhuma despesa encontrada</td></tr>';
      return;
    }
    despesas.forEach(despesa => {
      if (!despesa.id || !despesa.descricao || despesa.valor === undefined || !despesa.data_despesa) {
        console.warn('Despesa inválida: ' + JSON.stringify(despesa));
        return;
      }
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${despesa.id}</td>
        <td>${despesa.descricao}</td>
        <td>${parseFloat(despesa.valor).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}</td>
        <td>${formatarCategoria(despesa.categoria)}</td>
        <td>${formatarData(despesa.data_despesa)}</td>
        <td>${despesa.tipo === 'fixa' ? 'Fixa' : 'Variável'}</td>
        <td>${formatarData(despesa.data_criacao)}</td>
        <td>
          <button class="button is-small is-info" onclick='abrirEditModal(${JSON.stringify(despesa)})'>Editar</button>
        </td>`;
      tbody.appendChild(row);
    });
  } catch (error) {
    console.error('Erro ao atualizar despesas:', error);
    tbody.innerHTML = '<tr><td colspan="8" class="has-text-centered">Erro ao carregar despesas</td></tr>';
    showToast('Não foi possível carregar as despesas: ' + error.message, 'error');
  }
}

// Função para carregar categorias do backend
async function carregarCategorias() {
  try {
    const response = await fetch('/api/categorias/despesas', {
      headers: { 'Accept': 'application/json' }
    });
    if (!response.ok) {
      const text = await response.text();
      throw new Error(`Erro ao carregar categorias: ${response.status} ${response.statusText}`);
    }
    const categorias = await response.json();
    return categorias;
  } catch (error) {
    console.error('Erro ao carregar categorias:', error);
    showToast('Não foi possível carregar as categorias: ' + error.message, 'error');
    return [];
  }
}

// Função para popular um <select> com categorias
function popularSelectComCategorias(selectElement, categorias, valorSelecionado = '') {
  if (!selectElement) {
    console.error('Elemento <select> não encontrado');
    return;
  }
  selectElement.innerHTML = '<option value="">Selecione uma categoria</option>';
  categorias.forEach(categoria => {
    const option = document.createElement('option');
    option.value = categoria.id; // id é o valor do ENUM (ex.: 'utilidades')
    option.textContent = categoria.nome; // nome é a versão formatada (ex.: 'Utilidades')
    if (categoria.id === valorSelecionado) {
      option.selected = true;
    }
    selectElement.appendChild(option);
  });
}

// Função para atualizar todos os selects de categorias
async function atualizarSelectsCategorias() {
  const categorias = await carregarCategorias();
  const selectFiltroCategoria = document.getElementById('categoria');
  const selectAddCategoria = document.getElementById('addCategoria');
  const selectEditCategoria = document.getElementById('editCategoria');
  if (selectFiltroCategoria) {
    selectFiltroCategoria.innerHTML = '<option value="">Todas as Categorias</option>';
    categorias.forEach(categoria => {
      const option = document.createElement('option');
      option.value = categoria.id;
      option.textContent = categoria.nome;
      selectFiltroCategoria.appendChild(option);
    });
  }
  if (selectAddCategoria) {
    popularSelectComCategorias(selectAddCategoria, categorias);
  }
  if (selectEditCategoria) {
    popularSelectComCategorias(selectEditCategoria, categorias);
  }
}

// Função para adicionar uma nova categoria
async function addCategoria() {
  const novaCategoriaInput = document.getElementById('novaCategoria');
  const novaCategoria = novaCategoriaInput?.value.trim();
  if (!novaCategoria) {
    showToast('Por favor, insira o nome da nova categoria', 'error');
    return;
  }
  if (!/^[a-zA-Z\s]{1,50}$/.test(novaCategoria)) {
    showToast('O nome da categoria deve conter apenas letras e espaços, até 50 caracteres', 'error');
    return;
  }
  try {
    const response = await fetch('/api/despesas/categorias/adicionar', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
      body: JSON.stringify({ novaCategoria })
    });
    if (!response.ok) {
      let errorData;
      try {
        errorData = await response.json();
      } catch (e) {
        throw new Error(`Erro na resposta do servidor: ${response.status} ${response.statusText}`);
      }
      throw new Error(errorData.error || errorData.erro || `Erro na resposta do servidor: ${response.status} ${response.statusText}`);
    }
    const data = await response.json();
    showToast(data.mensagem, 'success');
    novaCategoriaInput.value = '';
    await atualizarSelectsCategorias();
  } catch (error) {
    console.error('Erro ao adicionar categoria:', error);
    showToast('Não foi possível adicionar a categoria: ' + error.message, 'error');
  }
}

// Função para abrir modal de adição
function abrirAddModal() {
  const modal = document.getElementById('addDespesaModal');
  if (!modal) {
    console.error('Modal addDespesaModal não encontrado');
    showToast('Erro: Modal de adição não encontrado', 'error');
    return;
  }
  modal.classList.add('is-active');
  carregarCategorias().then(categorias => {
    const selectAddCategoria = document.getElementById('addCategoria');
    if (selectAddCategoria) {
      popularSelectComCategorias(selectAddCategoria, categorias);
    } else {
      console.error('Elemento addCategoria não encontrado');
      showToast('Erro: Campo de categoria não encontrado', 'error');
    }
  });
}

// Função para fechar modal de adição
function closeAddModal() {
  const modal = document.getElementById('addDespesaModal');
  if (modal) {
    modal.classList.remove('is-active');
    const form = document.getElementById('addDespesaForm');
    if (form) form.reset();
  }
}

// Função para salvar nova despesa
async function salvarNovaDespesa() {
  const descricao = document.getElementById('addDescricao')?.value.trim();
  const valor = parseFloat(document.getElementById('addValor')?.value);
  const categoria = document.getElementById('addCategoria')?.value;
  const data_despesa = document.getElementById('addDataDespesa')?.value;
  const tipo = document.getElementById('addTipo')?.value;
  const today = new Date().toISOString().split('T')[0];
  if (!descricao || isNaN(valor) || valor <= 0 || !categoria || !data_despesa || !tipo) {
    showToast('Por favor, preencha todos os campos corretamente', 'error');
    return;
  }
  if (data_despesa > today) {
    showToast('A data da despesa não pode ser futura', 'error');
    return;
  }
  if (descricao.length < 3) {
    showToast('A descrição deve ter pelo menos 3 caracteres', 'error');
    return;
  }
  try {
    const response = await fetch('/api/despesas', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
      body: JSON.stringify({ descricao, valor, categoria, data_despesa, tipo })
    });
    if (!response.ok) {
      const errorData = await response.json();
      throw new Error(errorData.erro || `Erro na resposta do servidor: ${response.status} ${response.statusText}`);
    }
    showToast('A despesa foi registrada com sucesso', 'success');
    closeAddModal();
    atualizarDespesas();
  } catch (error) {
    console.error('Erro ao adicionar despesa:', error);
    showToast('Não foi possível registrar a despesa: ' + error.message, 'error');
  }
}

// Função para abrir modal de edição
function abrirEditModal(despesa) {
  const modal = document.getElementById('editDespesaModal');
  if (!modal) {
    console.error('Modal editDespesaModal não encontrado');
    showToast('Erro: Modal de edição não encontrado', 'error');
    return;
  }
  document.getElementById('editId').value = despesa.id;
  document.getElementById('editDescricao').value = despesa.descricao;
  document.getElementById('editValor').value = parseFloat(despesa.valor).toFixed(2);
  document.getElementById('editDataDespesa').value = despesa.data_despesa.split('T')[0];
  document.getElementById('editTipo').value = despesa.tipo;
  modal.classList.add('is-active');
  carregarCategorias().then(categorias => {
    const selectEditCategoria = document.getElementById('editCategoria');
    if (selectEditCategoria) {
      popularSelectComCategorias(selectEditCategoria, categorias, despesa.categoria);
    } else {
      console.error('Elemento editCategoria não encontrado');
      showToast('Erro: Campo de categoria não encontrado', 'error');
    }
  });
}

// Função para fechar modal de edição
function closeEditModal() {
  const modal = document.getElementById('editDespesaModal');
  if (modal) modal.classList.remove('is-active');
}

// Função para salvar edição
async function salvarEdicao() {
  const id = document.getElementById('editId')?.value;
  const descricao = document.getElementById('editDescricao')?.value.trim();
  const valor = parseFloat(document.getElementById('editValor')?.value);
  const categoria = document.getElementById('editCategoria')?.value;
  const data_despesa = document.getElementById('editDataDespesa')?.value;
  const tipo = document.getElementById('editTipo')?.value;
  const today = new Date().toISOString().split('T')[0];
  if (!id || !descricao || isNaN(valor) || valor <= 0 || !categoria || !data_despesa || !tipo) {
    showToast('Por favor, preencha todos os campos corretamente', 'error');
    return;
  }
  if (data_despesa > today) {
    showToast('A data da despesa não pode ser futura', 'error');
    return;
  }
  if (descricao.length < 3) {
    showToast('A descrição deve ter pelo menos 3 caracteres', 'error');
    return;
  }
  try {
    const response = await fetch(`/api/despesas/${id}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
      body: JSON.stringify({ descricao, valor, categoria, data_despesa, tipo })
    });
    if (!response.ok) {
      const errorData = await response.json();
      throw new Error(errorData.erro || `Erro na resposta do servidor: ${response.status} ${response.statusText}`);
    }
    showToast('A despesa foi atualizada com sucesso', 'success');
    closeEditModal();
    atualizarDespesas();
  } catch (error) {
    console.error('Erro ao atualizar despesa:', error);
    showToast('Não foi possível atualizar a despesa: ' + error.message, 'error');
  }
}

// Função para confirmar deleção
function confirmarDelecao() {
  abrirModalConfirmacao('Tem certeza que deseja deletar?', () => {
  deletarDespesa();
});

}

// Função para deletar despesa
async function deletarDespesa() {
  const id = document.getElementById('editId')?.value;
  if (!id) {
    showToast('ID da despesa não encontrado', 'error');
    return;
  }
  try {
    const response = await fetch(`/api/despesas/${id}`, {
      method: 'DELETE',
      headers: { 'Accept': 'application/json' }
    });
    if (!response.ok) {
      const errorData = await response.json();
      throw new Error(errorData.erro || `Erro na resposta do servidor: ${response.status} ${response.statusText}`);
    }
    showToast('A despesa foi deletada com sucesso', 'success');
    closeEditModal();
    atualizarDespesas();
  } catch (error) {
    console.error('Erro ao deletar despesa:', error);
    showToast('Não foi possível deletar a despesa: ' + error.message, 'error');
  }
}

// Função para exportar tabela como CSV
function exportarCsv() {
  const table = document.getElementById('despesasTable');
  if (!table) {
    console.error('Tabela despesasTable não encontrada');
    showToast('Erro: Tabela de despesas não encontrada', 'error');
    return;
  }
  let csv = [];
  const headers = Array.from(table.querySelectorAll('thead th')).map(th => th.textContent).slice(0, -1);
  csv.push(headers.join(','));
  const rows = table.querySelectorAll('tbody tr');
  rows.forEach(row => {
    const cells = Array.from(row.querySelectorAll('td')).slice(0, -1).map(cell => `"${cell.textContent.replace(/"/g, '""')}"`);
    csv.push(cells.join(','));
  });
  const csvContent = 'data:text/csv;charset=utf-8,' + encodeURIComponent(csv.join('\n'));
  const link = document.createElement('a');
  link.setAttribute('href', csvContent);
  link.setAttribute('download', `despesas_${new Date().toISOString().split('T')[0]}.csv`);
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

// Inicialização
document.addEventListener('DOMContentLoaded', () => {
  try {
    // Carrega as despesas
    atualizarDespesas();

    // Carrega categorias no filtro, adição e edição
    atualizarSelectsCategorias();

    // Filtro de despesas
    const filterForm = document.getElementById('filterDespesasForm');
    if (filterForm) {
      filterForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const filtros = {
          descricao: document.getElementById('descricao')?.value || '',
          categoria: document.getElementById('categoria')?.value || '',
          tipo: document.getElementById('tipo')?.value || ''
        };
        atualizarDespesas(filtros);
      });
    } else {
      console.error('Formulário filterDespesasForm não encontrado');
      showToast('Erro: Formulário de filtros não encontrado', 'error');
    }

    // Botão de atualização
    const refreshBtn = document.getElementById('refreshDespesasBtn');
    if (refreshBtn) {
      refreshBtn.addEventListener('click', () => {
        atualizarDespesas();
      });
    } else {
      console.error('Botão refreshDespesasBtn não encontrado');
      showToast('Erro: Botão de atualização não encontrado', 'error');
    }

    // Botão de adicionar despesa
    const addDespesaBtn = document.getElementById('addDespesaBtn');
    if (addDespesaBtn) {
      addDespesaBtn.addEventListener('click', abrirAddModal);
    } else {
      console.error('Botão addDespesaBtn não encontrado');
      showToast('Erro: Botão de adição não encontrado', 'error');
    }

    // Botão de exportar CSV
    const exportCsvBtn = document.getElementById('exportCsvBtn');
    if (exportCsvBtn) {
      exportCsvBtn.addEventListener('click', exportarCsv);
    } else {
      console.error('Botão exportCsvBtn não encontrado');
      showToast('Erro: Botão de exportação não encontrado', 'error');
    }

    // Formulário de adicionar categoria
    const addCategoriaForm = document.getElementById('addCategoriaForm');
    if (addCategoriaForm) {
      addCategoriaForm.addEventListener('submit', (e) => {
        e.preventDefault();
        addCategoria();
      });
    } else {
      console.error('Formulário addCategoriaForm não encontrado');
      showToast('Erro: Formulário de adição de categoria não encontrado', 'error');
    }
  } catch (error) {
    console.error('Erro na inicialização:', error);
    showToast('Erro na inicialização da página: ' + error.message, 'error');
  }
});
let callbackConfirmacao = null;

function abrirModalConfirmacao(mensagem, callback) {
  document.getElementById("mensagemConfirmacao").textContent = mensagem;
  document.getElementById("modalConfirmacao").classList.add("is-active");
  callbackConfirmacao = callback;
}

function fecharModalConfirmacao() {
  document.getElementById("modalConfirmacao").classList.remove("is-active");
  callbackConfirmacao = null;
}

document.addEventListener("DOMContentLoaded", () => {
  document.getElementById("btnConfirmar").addEventListener("click", () => {
    if (typeof callbackConfirmacao === "function") callbackConfirmacao();
    fecharModalConfirmacao();
  });
});
</script>
<!-- Modal de Confirmação -->
<div class="modal" id="modalConfirmacao">
  <div class="modal-background"></div>
  <div class="modal-card">
    <header class="modal-card-head">
      <p class="modal-card-title">Confirmação</p>
      <button class="delete" aria-label="close" onclick="fecharModalConfirmacao()"></button>
    </header>
    <section class="modal-card-body" id="mensagemConfirmacao">
      Você tem certeza?
    </section>
    <footer class="modal-card-foot">
      <button class="button is-success" id="btnConfirmar">Sim</button>
      <button class="button" onclick="fecharModalConfirmacao()">Cancelar</button>
    </footer>
  </div>
</body>
</html>