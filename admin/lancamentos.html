<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Lançamentos</title>
  <link rel="stylesheet" href="css/main.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
  <link rel="stylesheet" href="https://cdn.materialdesignicons.com/5.4.55/css/materialdesignicons.min.css">
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>

<body>
<div id="app">
  <!-- Navbar -->
  <nav class="navbar is-fixed-top">
    <div class="navbar-brand">
      <a class="navbar-item is-hidden-desktop jb-aside-mobile-toggle">
        <span class="icon"><i class="mdi mdi-forwardburger mdi-24px"></i></span>
      </a>
    </div>
    <div class="navbar-menu" id="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" onclick="logout()">
          <span class="icon"><i class="mdi mdi-logout"></i></span> <span>Logout</span>
        </a>
      </div>
    </div>
  </nav>

  <!-- Sidebar -->
  <aside class="aside is-expanded">
    <div class="menu is-menu-main">
      <p class="menu-label">Geral</p>
      <ul class="menu-list">
        <li><a href="index.html" class="has-icon"><i class="mdi mdi-desktop-mac"></i> Dashboard</a></li>
        <li><a href="usuarios.html" class="has-icon"><i class="mdi mdi-account-circle"></i> Usuários</a></li>
        <li><a href="estoque.html" class="has-icon"><i class="mdi mdi-warehouse"></i> Estoque</a></li>
        <li><a href="despesas.html" class="has-icon"><i class="mdi mdi-currency-brl"></i> Despesas</a></li>
        <li><a href="lancamentos.html" class="is-active has-icon"><i class="mdi mdi-book-open-variant"></i> Lançamentos</a></li>
      </ul>
    </div>
  </aside>

  <!-- Main Section -->
  <section class="section is-main-section">
    <div class="level">
      <div class="level-left">
        <div class="level-item">
          <h1 class="title">Lançamentos</h1>
        </div>
      </div>
      <div class="level-right">
        <div class="level-item">
          <button class="button is-success mr-2" onclick="openAddModal()">Adicionar</button>
          <button class="button is-info mr-2" onclick="exportCsv()">Exportar CSV</button>
          <button class="button is-primary" onclick="loadLancamentos()">Atualizar</button>
        </div>
      </div>
    </div>

    <div class="table-container">
      <table class="table is-fullwidth is-striped is-hoverable">
        <thead>
          <tr>
            <th>ID</th>
            <th>Descrição</th>
            <th>Valor (R$)</th>
            <th>Categoria</th>
            <th>Data</th>
            <th>Tipo</th>
            <th>Ações</th>
          </tr>
        </thead>
        <tbody id="lancamentosTable"></tbody>
      </table>
    </div>
  </section>

  <!-- Modal -->
  <div class="modal" id="lancamentoModal">
    <div class="modal-background"></div>
    <div class="modal-card">
      <header class="modal-card-head">
        <p class="modal-card-title" id="modalTitle">Adicionar Lançamento</p>
        <button class="delete" aria-label="close" onclick="closeModal()"></button>
      </header>
      <section class="modal-card-body">
        <input type="hidden" id="lancamentoId">
        <div class="field">
          <label class="label">Descrição</label>
          <div class="control">
            <input class="input" id="descricao" type="text" required>
          </div>
        </div>
        <div class="field">
          <label class="label">Valor (R$)</label>
          <div class="control">
            <input class="input" id="valor" type="number" step="0.01" required>
          </div>
        </div>
        <div class="field">
          <label class="label">Categoria</label>
          <div class="control">
            <input class="input" id="categoria" type="text">
          </div>
        </div>
        <div class="field">
          <label class="label">Data</label>
          <div class="control">
            <input class="input" id="data" type="date" required>
          </div>
        </div>
        <div class="field">
          <label class="label">Tipo</label>
          <div class="control">
            <div class="select is-fullwidth">
              <select id="tipo">
                <option value="receita">Receita</option>
                <option value="despesa">Despesa</option>
              </select>
            </div>
          </div>
        </div>
      </section>
      <footer class="modal-card-foot">
        <button class="button is-success" onclick="salvarLancamento()">Salvar</button>
        <button class="button" onclick="closeModal()">Cancelar</button>
      </footer>
    </div>
  </div>
</div>

<script>
  const API_URL = '/api/lancamentos';

  function logout() {
    localStorage.removeItem('usuario');
    localStorage.removeItem('permissao');
    window.location.href = 'login.html';
  }

  function openAddModal() {
    document.getElementById('modalTitle').innerText = 'Adicionar Lançamento';
    document.getElementById('lancamentoId').value = '';
    document.getElementById('descricao').value = '';
    document.getElementById('valor').value = '';
    document.getElementById('categoria').value = '';
    document.getElementById('data').value = '';
    document.getElementById('tipo').value = 'receita';
    document.getElementById('lancamentoModal').classList.add('is-active');
  }

  function openEditModal(l) {
    document.getElementById('modalTitle').innerText = 'Editar Lançamento';
    document.getElementById('lancamentoId').value = l.id;
    document.getElementById('descricao').value = l.descricao;
    document.getElementById('valor').value = l.valor;
    document.getElementById('categoria').value = l.categoria;
    document.getElementById('data').value = l.data_lancamento;
    document.getElementById('tipo').value = l.tipo;
    document.getElementById('lancamentoModal').classList.add('is-active');
  }

  function closeModal() {
    document.getElementById('lancamentoModal').classList.remove('is-active');
  }

  async function loadLancamentos() {
    const res = await axios.get(API_URL);
    const data = res.data;
    const tbody = document.getElementById('lancamentosTable');
    tbody.innerHTML = '';
    data.forEach(l => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${l.id}</td>
        <td>${l.descricao}</td>
        <td>${Number(l.valor).toFixed(2)}</td>
        <td>${l.categoria || ''}</td>
        <td>${new Date(l.data_lancamento).toLocaleDateString()}</td>
        <td>${l.tipo}</td>
        <td>
          <button class="button is-small is-info mr-2" onclick='openEditModal(${JSON.stringify(l)})'>Editar</button>
          <button class="button is-small is-danger" onclick='deletarLancamento(${l.id})'>Excluir</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  async function salvarLancamento() {
    const id = document.getElementById('lancamentoId').value;
    const payload = {
      descricao: document.getElementById('descricao').value,
      valor: document.getElementById('valor').value,
      categoria: document.getElementById('categoria').value,
      data_lancamento: document.getElementById('data').value,
      tipo: document.getElementById('tipo').value
    };
    if (id) {
      await axios.put(`${API_URL}/${id}`, payload);
    } else {
      await axios.post(API_URL, payload);
    }
    closeModal();
    loadLancamentos();
  }

  async function deletarLancamento(id) {
    if (confirm('Tem certeza que deseja excluir este lançamento?')) {
      await axios.delete(`${API_URL}/${id}`);
      loadLancamentos();
    }
  }

  function exportCsv() {
    const rows = [['ID', 'Descrição', 'Valor', 'Categoria', 'Data', 'Tipo']];
    const trs = document.querySelectorAll('#lancamentosTable tr');
    trs.forEach(tr => {
      const cells = [...tr.children].map(td => td.innerText);
      rows.push(cells);
    });
    const csv = rows.map(e => e.join(',')).join('\n');
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = 'lancamentos.csv';
    link.click();
    URL.revokeObjectURL(url);
  }

  document.addEventListener('DOMContentLoaded', loadLancamentos);
</script>

<style>
  .table-container {
    max-height: 500px;
    overflow-y: auto;
  }
</style>
</body>
</html>
