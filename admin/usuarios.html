<!DOCTYPE html>
<html lang="pt-BR" class="has-aside-left has-aside-mobile-transition has-navbar-fixed-top has-aside-expanded">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Gestão de Usuários - Admin</title>
  <link rel="stylesheet" href="css/main.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
  <link rel="dns-prefetch" href="https://fonts.gstatic.com">
  <link href="https://fonts.googleapis.com/css?family=Nunito" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="https://cdn.materialdesignicons.com/4.9.95/css/materialdesignicons.min.css">
</head>
<body>
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const usuario = localStorage.getItem('usuario');
      const permissao = localStorage.getItem('permissao');
  
      // Verifica se o usuário e permissão estão armazenados no localStorage
      if (!usuario || !permissao) {
        alert('Você não está autenticado! Redirecionando para o login...');
        window.location.href = '../login.html'; // Redireciona para a página de login
      }
  
      // Verificação adicional para garantir que o usuário tem a permissão certa para acessar a página
      if (permissao !== 'admin') {
        alert('Você não tem permissão para acessar essa área!');
        window.location.href = '../login.html'; // Redireciona para o login se não tiver permissão
      }
    });
  </script>
  <div id="app">
    <nav id="navbar-main" class="navbar is-fixed-top">
      <div class="navbar-brand">
        <a class="navbar-item is-hidden-desktop jb-aside-mobile-toggle">
          <span class="icon"><i class="mdi mdi-forwardburger mdi-24px"></i></span>
        </a>
      </div>
      <div class="navbar-brand is-right">
        <a class="navbar-item is-hidden-desktop jb-navbar-menu-toggle" data-target="navbar-menu">
          <span class="icon"><i class="mdi mdi-dots-vertical"></i></span>
        </a>
      </div>
      <div class="navbar-menu fadeIn animated faster" id="navbar-menu">
        <div class="navbar-end">
          <a title="Log out" class="navbar-item is-desktop-icon-only" href="#">
            <span class="icon"><i class="mdi mdi-logout"></i></span><span>Log out</span>
          </a>
        </div>
      </div>
    </nav>
    <aside class="aside is-placed-left is-expanded">
      <div class="aside-tools">
        <div class="aside-tools-label">
          <span><b>Admin</b></span>
        </div>
      </div>
      <div class="menu is-menu-main">
        <p class="menu-label">Geral</p>
        <ul class="menu-list">
          <li><a href="index.html" class="has-icon"><span class="icon"><i class="mdi mdi-desktop-mac"></i></span><span class="menu-item-label">Dashboard</span></a></li>
          <li><a href="usuarios.html" class="is-active has-icon"><span class="icon"><i class="mdi mdi-account-circle"></i></span><span class="menu-item-label">Usuários</span></a></li>
          <li><a href="estoque.html" class="has-icon"><span class="icon"><i class="mdi mdi-warehouse"></i></span><span class="menu-item-label">Estoque</span></a></li>
          <li><a href="despesas.html" class=" has-icon"><span class="icon"><i class="mdi mdi-currency-brl"></i></span><span class="menu-item-label">Despesas</span></a></li>
        </ul>
        <p class="menu-label">Logic Ice</p>
        <ul class="menu-list">
          <li><a href="../producao.html" class="has-icon"><span class="icon has-update-mark"><i class="mdi mdi-table"></i></span><span class="menu-item-label">Produção</span></a></li>
          <li><a href="vendas.html" class="has-icon"><span class="icon"><i class="mdi mdi-square-edit-outline"></i></span><span class="menu-item-label">Vendas</span></a></li>
          <li><a href="entregas.html" class="has-icon"><span class="icon"><i class="mdi mdi-square-edit-outline"></i></span><span class="menu-item-label">Entregas</span></a></li>
        </ul>
      </div>
    </aside>
    <section class="section is-title-bar">
      <div class="level">
        <div class="level-left">
          <div class="level-item">
            <ul>
              <li>Admin</li>
              <li>Gestão de Usuários</li>
            </ul>
          </div>
        </div>
      </div>
    </section>
    <section class="hero is-hero-bar">
      <div class="hero-body">
        <div class="level">
          <div class="level-left">
            <div class="level-item"><h1 class="title">Gestão de Usuários</h1></div>
          </div>
          <div class="level-right">
            <div class="level-item">
              <button class="button is-primary" id="addUserBtn">
                <span class="icon"><i class="mdi mdi-plus"></i></span>
                <span>Adicionar Novo Usuário</span>
              </button>
            </div>
          </div>
        </div>
      </div>
    </section>
    <section class="section is-main-section">
      <div class="field">
        <div class="control has-icons-left">
          <input class="input" type="text" id="searchInput" placeholder="Pesquisar por nome, número, cargo ou departamento">
          <span class="icon is-small is-left"><i class="mdi mdi-magnify"></i></span>
        </div>
      </div>
      <div id="message" class="notification is-hidden"></div>
      <div class="card has-table">
        <header class="card-header">
          <p class="card-header-title">
            <span class="icon"><i class="mdi mdi-account-multiple"></i></span>
            Usuários
          </p>
          <a href="#" class="card-header-icon" id="reloadTable">
            <span class="icon"><i class="mdi mdi-reload"></i></span>
          </a>
        </header>
        <div class="card-content">
          <div class="b-table has-pagination">
            <div class="table-wrapper has-mobile-cards">
              <table class="table is-fullwidth is-striped is-hoverable is-fullwidth" id="userTable">
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Nome</th>
                    <th>Número</th>
                    <th>Cargo</th>
                    <th>Departamento</th>
                    <th>Email</th>
                    <th>Data de Contratação</th>
                    <th>Salário</th>
                    <th>Data de Registro</th>
                    <th>Ações</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </section>

    <div class="modal" id="userModal">
      <div class="modal-background"></div>
      <div class="modal-card">
        <header class="modal-card-head">
          <p class="modal-card-title" id="modalTitle">Adicionar Usuário</p>
          <button class="delete" aria-label="Fechar modal" id="closeModal"></button>
        </header>
        <section class="modal-card-body">
          <form id="userForm">
            <input type="hidden" id="userId">
            <div class="field">
              <label class="label">Nome</label>
              <div class="control">
                <input class="input" type="text" id="nome" required>
              </div>
              <p class="help is-danger is-hidden" id="nomeError">Nome deve ter pelo menos 3 caracteres e conter apenas letras e espaços.</p>
            </div>
            <div class="field">
              <label class="label">Número (WhatsApp)</label>
              <div class="control">
                <input class="input" type="tel" id="numero" placeholder="55XX9XXXXXXXX" required>
              </div>
              <p class="help is-danger is-hidden" id="numeroError">Insira um número válido (ex.: 55XX9XXXXXXXX).</p>
            </div>
            <div class="field">
              <label class="label">Cargo</label>
              <div class="control">
                <input class="input" type="text" id="cargo" required>
              </div>
              <p class="help is-danger is-hidden" id="cargoError">Cargo deve ter pelo menos 3 caracteres.</p>
            </div>
            <div class="field">
              <label class="label">Departamento</label>
              <div class="control">
                <input class="input" type="text" id="departamento" required>
              </div>
              <p class="help is-danger is-hidden" id="departamentoError">Departamento deve ter pelo menos 3 caracteres.</p>
            </div>
            <div class="field">
              <label class="label">Email</label>
              <div class="control">
                <input class="input" type="email" id="email" required>
              </div>
              <p class="help is-danger is-hidden" id="emailError">Insira um email válido (ex.: usuario@exemplo.com).</p>
            </div>
            <div class="field">
              <label class="label">Data de Contratação</label>
              <div class="control">
                <input class="input" type="date" id="data_contratacao" required>
              </div>
              <p class="help is-danger is-hidden" id="data_contratacaoError">Data de contratação não pode ser futura.</p>
            </div>
            <div class="field">
              <label class="label">Salário (R$)</label>
              <div class="control">
                <input class="input" type="number" id="salario" step="0.01" min="0" required>
              </div>
              <p class="help is-danger is-hidden" id="salarioError">Salário deve ser um valor positivo.</p>
            </div>
          </form>
        </section>
        <footer class="modal-card-foot">
          <button class="button is-success" id="saveUser" disabled>Salvar</button>
          <button class="button" id="cancelModal">Cancelar</button>
        </footer>
      </div>
    </div>

    <div class="modal" id="deleteModal">
      <div class="modal-background"></div>
      <div class="modal-card">
        <header class="modal-card-head">
          <p class="modal-card-title">Confirmar Exclusão</p>
          <button class="delete" aria-label="Fechar modal" id="closeDeleteModal"></button>
        </header>
        <section class="modal-card-body">
          <p>Tem certeza que deseja excluir <strong id="deleteUserName"></strong>?</p>
        </section>
        <footer class="modal-card-foot">
          <button class="button is-danger" id="confirmDelete">Excluir</button>
          <button class="button" id="cancelDelete">Cancelar</button>
        </footer>
      </div>
    </div>

    <footer class="footer">
      <div class="container-fluid">
        <div class="level">
          <div class="level-left">
            <div class="level-item">© 2025, M</div>
            <div class="level-item">
              <img src="https://img.shields.io/github/v/release/vikdiesel/admin-one-bulma-dashboard?color=%23999">
            </div>
          </div>
          <div class="level-right"><div class="level-item"></div></div>
        </div>
      </div>
    </footer>
  </div>

  <style>
    .table-container {
      max-height: 400px;
      overflow-y: auto;
    }
    .table th, .table td {
      padding: 0.75rem;
      text-align: left;
      border-bottom: 1px solid #e5e7eb;
    }
    .table th {
      background-color: #f3f4f6;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    .is-hidden {
      display: none;
    }
    .tooltip {
      position: relative;
      display: inline-block;
    }
    .tooltip .tooltiptext {
      visibility: hidden;
      width: 120px;
      background-color: #555;
      color: #fff;
      text-align: center;
      border-radius: 6px;
      padding: 5px;
      position: absolute;
      z-index: 1;
      bottom: 125%;
      left: 50%;
      margin-left: -60px;
      opacity: 0;
      transition: opacity 0.3s;
    }
    .tooltip:hover .tooltiptext {
      visibility: visible;
      opacity: 1;
    }
  </style>

  <script type="text/javascript" src="js/main.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const userModal = document.getElementById('userModal');
      const deleteModal = document.getElementById('deleteModal');
      const addUserBtn = document.getElementById('addUserBtn');
      const closeModal = document.getElementById('closeModal');
      const cancelModal = document.getElementById('cancelModal');
      const saveUser = document.getElementById('saveUser');
      const userForm = document.getElementById('userForm');
      const userTable = document.getElementById('userTable').getElementsByTagName('tbody')[0];
      const message = document.getElementById('message');
      const confirmDelete = document.getElementById('confirmDelete');
      const cancelDelete = document.getElementById('cancelDelete');
      const closeDeleteModal = document.getElementById('closeDeleteModal');
      const searchInput = document.getElementById('searchInput');
      let currentUserId = null;
      let users = [];

      const showMessage = (text, type) => {
        message.textContent = text;
        message.className = `notification is-${type}`;
        message.classList.remove('is-hidden');
        setTimeout(() => message.classList.add('is-hidden'), 5000);
      };

      const validateForm = () => {
        let isValid = true;
        const nome = document.getElementById('nome').value.trim();
        const numero = document.getElementById('numero').value.trim();
        const cargo = document.getElementById('cargo').value.trim();
        const departamento = document.getElementById('departamento').value.trim();
        const email = document.getElementById('email').value.trim();
        const data_contratacao = document.getElementById('data_contratacao').value;
        const salario = document.getElementById('salario').value;

        // Reset error messages
        document.querySelectorAll('.help.is-danger').forEach(el => el.classList.add('is-hidden'));

        // Nome validation
        if (!nome || nome.length < 3 || !/^[A-Za-z\s]+$/.test(nome)) {
          document.getElementById('nomeError').classList.remove('is-hidden');
          isValid = false;
        }

        // Número validation
        if (!numero || !/^\d{10,15}$/.test(numero)) {
          document.getElementById('numeroError').classList.remove('is-hidden');
          isValid = false;
        }

        // Cargo validation
        if (!cargo || cargo.length < 3) {
          document.getElementById('cargoError').classList.remove('is-hidden');
          isValid = false;
        }

        // Departamento validation
        if (!departamento || departamento.length < 3) {
          document.getElementById('departamentoError').classList.remove('is-hidden');
          isValid = false;
        }

        // Email validation
        if (!email || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
          document.getElementById('emailError').classList.remove('is-hidden');
          isValid = false;
        }

        // Data de contratação validation
        const today = new Date().toISOString().split('T')[0];
        if (!data_contratacao || data_contratacao > today) {
          document.getElementById('data_contratacaoError').classList.remove('is-hidden');
          isValid = false;
        }

        // Salário validation
        if (!salario || salario <= 0) {
          document.getElementById('salarioError').classList.remove('is-hidden');
          isValid = false;
        }

        saveUser.disabled = !isValid;
        return isValid;
      };

      const loadUsers = async () => {
        try {
          const response = await fetch('/api/usuarios');
          if (!response.ok) throw new Error('Erro na resposta da API');
          users = await response.json();
          renderTable(users);
        } catch (error) {
          showMessage('Erro ao carregar usuários', 'danger');
        }
      };

      const renderTable = (data) => {
        userTable.innerHTML = '';
        data.forEach(user => {
          const row = userTable.insertRow();
          row.innerHTML = `
            <td>${user.id}</td>
            <td>${user.nome}</td>
            <td>${user.numero}</td>
            <td>${user.cargo || '-'}</td>
            <td>${user.departamento || '-'}</td>
            <td>${user.email || '-'}</td>
            <td>${user.data_contratacao ? new Date(user.data_contratacao).toLocaleDateString('pt-BR') : '-'}</td>
            <td>${user.salario ? parseFloat(user.salario).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) : '-'}</td>
            <td>${new Date(user.data_registro).toLocaleDateString('pt-BR')}</td>
            <td>
              <div class="buttons is-right">
                <button class="button is-small is-primary edit-btn tooltip" data-id="${user.id}">
                  <span class="icon"><i class="mdi mdi-pencil"></i></span>
                  <span class="tooltiptext">Editar Usuário</span>
                </button>
                <button class="button is-small is-danger delete-btn tooltip" data-id="${user.id}" data-name="${user.nome}">
                  <span class="icon"><i class="mdi mdi-trash-can"></i></span>
                  <span class="tooltiptext">Excluir Usuário</span>
                </button>
              </div>
            </td>
          `;
        });
      };

      const resetForm = () => {
        userForm.reset();
        document.getElementById('userId').value = '';
        document.getElementById('modalTitle').textContent = 'Adicionar Usuário';
        document.querySelectorAll('.help.is-danger').forEach(el => el.classList.add('is-hidden'));
        saveUser.disabled = true;
      };

      addUserBtn.addEventListener('click', () => {
        resetForm();
        userModal.classList.add('is-active');
      });

      closeModal.addEventListener('click', () => userModal.classList.remove('is-active'));
      cancelModal.addEventListener('click', () => userModal.classList.remove('is-active'));

      saveUser.addEventListener('click', async () => {
        if (!validateForm()) return;

        const id = document.getElementById('userId').value;
        const user = {
          nome: document.getElementById('nome').value.trim(),
          numero: document.getElementById('numero').value.trim(),
          cargo: document.getElementById('cargo').value.trim(),
          departamento: document.getElementById('departamento').value.trim(),
          email: document.getElementById('email').value.trim(),
          data_contratacao: document.getElementById('data_contratacao').value,
          salario: parseFloat(document.getElementById('salario').value)
        };

        try {
          const method = id ? 'PUT' : 'POST';
          const url = id ? `/api/usuarios/${id}` : '/api/usuarios';
          const response = await fetch(url, {
            method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(user)
          });
          if (response.ok) {
            userModal.classList.remove('is-active');
            showMessage(`Usuário ${id ? 'editado' : 'adicionado'} com sucesso!`, 'success');
            loadUsers();
          } else {
            const errorData = await response.json();
            showMessage(errorData.erro || 'Erro ao salvar usuário', 'danger');
          }
        } catch (error) {
          showMessage('Erro ao salvar usuário', 'danger');
        }
      });

      userTable.addEventListener('click', async (e) => {
        if (e.target.closest('.edit-btn')) {
          const id = e.target.closest('.edit-btn').dataset.id;
          try {
            const response = await fetch(`/api/usuarios/${id}`);
            if (!response.ok) throw new Error('Erro na resposta da API');
            const user = await response.json();
            document.getElementById('userId').value = user.id;
            document.getElementById('nome').value = user.nome;
            document.getElementById('numero').value = user.numero;
            document.getElementById('cargo').value = user.cargo || '';
            document.getElementById('departamento').value = user.departamento || '';
            document.getElementById('email').value = user.email || '';
            document.getElementById('data_contratacao').value = user.data_contratacao ? user.data_contratacao.split('T')[0] : '';
            document.getElementById('salario').value = user.salario || '';
            document.getElementById('modalTitle').textContent = 'Editar Usuário';
            userModal.classList.add('is-active');
            validateForm();
          } catch (error) {
            showMessage('Erro ao carregar dados do usuário', 'danger');
          }
        } else if (e.target.closest('.delete-btn')) {
          currentUserId = e.target.closest('.delete-btn').dataset.id;
          document.getElementById('deleteUserName').textContent = e.target.closest('.delete-btn').dataset.name;
          deleteModal.classList.add('is-active');
        }
      });

      confirmDelete.addEventListener('click', async () => {
        try {
          const response = await fetch(`/api/usuarios/${currentUserId}`, { method: 'DELETE' });
          if (response.ok) {
            deleteModal.classList.remove('is-active');
            showMessage('Usuário excluído com sucesso!', 'success');
            loadUsers();
          } else {
            showMessage('Erro ao excluir usuário', 'danger');
          }
        } catch (error) {
          showMessage('Erro ao excluir usuário', 'danger');
        }
      });

      cancelDelete.addEventListener('click', () => deleteModal.classList.remove('is-active'));
      closeDeleteModal.addEventListener('click', () => deleteModal.classList.remove('is-active'));

      document.getElementById('reloadTable').addEventListener('click', (e) => {
        e.preventDefault();
        loadUsers();
      });

      // Search functionality
      searchInput.addEventListener('input', () => {
        const query = searchInput.value.toLowerCase();
        const filtered = users.filter(user =>
          user.nome.toLowerCase().includes(query) ||
          user.numero.toLowerCase().includes(query) ||
          (user.cargo && user.cargo.toLowerCase().includes(query)) ||
          (user.departamento && user.departamento.toLowerCase().includes(query))
        );
        renderTable(filtered);
      });

      // Form validation on input
      userForm.addEventListener('input', validateForm);

      // Close modal with Esc key
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          userModal.classList.remove('is-active');
          deleteModal.classList.remove('is-active');
        }
      });

      // Submit form with Enter key
      userForm.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && validateForm()) {
          saveUser.click();
        }
      });

      loadUsers();
    });
  </script>
</body>
</html>